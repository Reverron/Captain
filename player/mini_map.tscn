[gd_scene load_steps=12 format=3 uid="uid://d03w3uebf0ig6"]

[ext_resource type="Script" uid="uid://dlek3vktstvss" path="res://player/mini_map.gd" id="1_1la25"]
[ext_resource type="Shader" uid="uid://bycjjbiep80bq" path="res://materials/mini_map.gdshader" id="1_r8eax"]
[ext_resource type="Texture2D" uid="uid://b8jpxcrm7bhvl" path="res://assets/icon.svg" id="4_dh8qp"]
[ext_resource type="Shader" uid="uid://cay33qbgsrg5t" path="res://player/screen_effect.gdshader" id="5_itq3j"]
[ext_resource type="Shader" uid="uid://dqa54i3pjcfs5" path="res://player/round.gdshader" id="5_l0kmr"]
[ext_resource type="Texture2D" uid="uid://wullxy8nd1te" path="res://assets/Radar.png" id="6_l0kmr"]

[sub_resource type="Shader" id="Shader_itq3j"]
code = "shader_type canvas_item;

uniform sampler2D SCREEN_TEXTURE : hint_screen_texture, filter_linear_mipmap;

uniform bool overlay = false;

uniform float scanlines_opacity : hint_range(0.0, 1.0) = 0.4;
uniform float scanlines_width : hint_range(0.0, 0.5) = 0.25;
uniform float grille_opacity : hint_range(0.0, 1.0) = 0.3;
uniform vec2 resolution = vec2(640.0, 480.0);

uniform bool pixelate = true;

uniform bool roll = true;
uniform float roll_speed = 8.0;
uniform float roll_size : hint_range(0.0, 100.0) = 15.0;
uniform float roll_variation : hint_range(0.1, 5.0) = 1.8;
uniform float distort_intensity : hint_range(0.0, 0.2) = 0.05;

uniform float noise_opacity : hint_range(0.0, 1.0) = 0.4;
uniform float noise_speed = 5.0;

uniform float static_noise_intensity : hint_range(0.0, 1.0) = 0.06;

uniform float aberration : hint_range(-1.0, 1.0) = 0.03;
uniform float brightness = 1.4;
uniform bool discolor = true;

uniform float warp_amount : hint_range(0.0, 5.0) = 1.0;
uniform bool clip_warp = false;

uniform float vignette_intensity = 0.4;
uniform float vignette_opacity : hint_range(0.0, 1.0) = 0.5;

vec2 random(vec2 uv){
    uv = vec2(dot(uv, vec2(127.1,311.7)), dot(uv, vec2(269.5,183.3)));
    return -1.0 + 2.0 * fract(sin(uv) * 43758.5453123);
}

float noise(vec2 uv) {
    vec2 uv_index = floor(uv);
    vec2 uv_fract = fract(uv);
    vec2 blur = smoothstep(0.0, 1.0, uv_fract);

    return mix(
        mix(dot(random(uv_index + vec2(0.0,0.0)), uv_fract - vec2(0.0,0.0)),
            dot(random(uv_index + vec2(1.0,0.0)), uv_fract - vec2(1.0,0.0)), blur.x),
        mix(dot(random(uv_index + vec2(0.0,1.0)), uv_fract - vec2(0.0,1.0)),
            dot(random(uv_index + vec2(1.0,1.0)), uv_fract - vec2(1.0,1.0)), blur.x), 
        blur.y
    ) * 0.5 + 0.5;
}

vec2 warp(vec2 uv){
    vec2 delta = uv - 0.5;
    float delta2 = dot(delta.xy, delta.xy);
    float delta4 = delta2 * delta2;
    float delta_offset = delta4 * warp_amount;
    return uv + delta * delta_offset;
}

float border (vec2 uv){
    float radius = min(warp_amount, 0.08);
    radius = max(min(min(abs(radius * 2.0), abs(1.0)), abs(1.0)), 1e-5);
    vec2 abs_uv = abs(uv * 2.0 - 1.0) - vec2(1.0, 1.0) + radius;
    float dist = length(max(vec2(0.0), abs_uv)) / radius;
    float square = smoothstep(0.96, 1.0, dist);
    return clamp(1.0 - square, 0.0, 1.0);
}

float vignette(vec2 uv){
    uv *= 1.0 - uv.xy;
    float vignette = uv.x * uv.y * 15.0;
    return pow(vignette, vignette_intensity * vignette_opacity);
}

void fragment()
{
    vec2 uv = overlay ? warp(SCREEN_UV) : warp(UV);
    vec2 text_uv = uv;
    vec2 roll_uv = vec2(0.0);
    float time = roll ? TIME : 0.0;

    if (pixelate){
        text_uv = ceil(uv * resolution) / resolution;
    }

    float roll_line = 0.0;
    if (roll || noise_opacity > 0.0){
        roll_line = smoothstep(0.3, 0.9, sin(uv.y * roll_size - (time * roll_speed)));
        roll_line *= roll_line * smoothstep(0.3, 0.9, sin(uv.y * roll_size * roll_variation - (time * roll_speed * roll_variation)));
        roll_uv = vec2((roll_line * distort_intensity * (1.-UV.x)), 0.0);
    }

    vec4 text;
    if (roll){
        text.r = texture(SCREEN_TEXTURE, text_uv + roll_uv * 0.8 + vec2(aberration, 0.0) * .1).r;
        text.g = texture(SCREEN_TEXTURE, text_uv + roll_uv * 1.2 - vec2(aberration, 0.0) * .1).g;
        text.b = texture(SCREEN_TEXTURE, text_uv + roll_uv).b;
        text.a = 1.0;
    } else {
        text.r = texture(SCREEN_TEXTURE, text_uv + vec2(aberration, 0.0) * .1).r;
        text.g = texture(SCREEN_TEXTURE, text_uv - vec2(aberration, 0.0) * .1).g;
        text.b = texture(SCREEN_TEXTURE, text_uv).b;
        text.a = 1.0;
    }

    float r = text.r;
    float g = text.g;
    float b = text.b;

    uv = warp(UV);

    if (grille_opacity > 0.0){
        float g_r = smoothstep(0.85, 0.95, abs(sin(uv.x * (resolution.x * 3.14159265))));
        r = mix(r, r * g_r, grille_opacity);

        float g_g = smoothstep(0.85, 0.95, abs(sin(1.05 + uv.x * (resolution.x * 3.14159265))));
        g = mix(g, g * g_g, grille_opacity);

        float b_b = smoothstep(0.85, 0.95, abs(sin(2.1 + uv.x * (resolution.x * 3.14159265))));
        b = mix(b, b * b_b, grille_opacity);
    }

    text.r = clamp(r * brightness, 0.0, 1.0);
    text.g = clamp(g * brightness, 0.0, 1.0);
    text.b = clamp(b * brightness, 0.0, 1.0);

    float scanlines = 0.5;
    if (scanlines_opacity > 0.0){
        scanlines = smoothstep(scanlines_width, scanlines_width + 0.5, abs(sin(uv.y * (resolution.y * 3.14159265))));
        text.rgb = mix(text.rgb, text.rgb * vec3(scanlines), scanlines_opacity);
    }

    if (noise_opacity > 0.0){
        float n = smoothstep(0.4, 0.5, noise(uv * vec2(2.0, 200.0) + vec2(10.0, (TIME * (noise_speed)))));
        roll_line *= n * scanlines * clamp(random((ceil(uv * resolution) / resolution) + vec2(TIME * 0.8, 0.0)).x + 0.8, 0.0, 1.0);
        text.rgb = clamp(mix(text.rgb, text.rgb + roll_line, noise_opacity), vec3(0.0), vec3(1.0));
    }

    if (static_noise_intensity > 0.0){
        text.rgb += clamp(random((ceil(uv * resolution) / resolution) + fract(TIME)).x, 0.0, 1.0) * static_noise_intensity;
    }

    text.rgb *= border(uv);
    text.rgb *= vignette(uv);

    if (clip_warp){
        text.a = border(uv);
    }

    if (discolor){
        float saturation = 0.5;
        float contrast = 1.2;
        vec3 greyscale = vec3(text.r + text.g + text.b) / 3.;
        text.rgb = mix(text.rgb, greyscale, saturation);

        float midpoint = pow(0.5, 2.2);
        text.rgb = (text.rgb - vec3(midpoint)) * contrast + midpoint;
    }

    COLOR = text;
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_4ereb"]
shader = SubResource("Shader_itq3j")
shader_parameter/overlay = false
shader_parameter/scanlines_opacity = 0.210000009975
shader_parameter/scanlines_width = 0.198000009405
shader_parameter/grille_opacity = 0.02400000114
shader_parameter/resolution = Vector2(640, 480)
shader_parameter/pixelate = true
shader_parameter/roll = true
shader_parameter/roll_speed = 2.0
shader_parameter/roll_size = 44.44800211128
shader_parameter/roll_variation = 0.59700002509762
shader_parameter/distort_intensity = 0.05
shader_parameter/noise_opacity = 0.59600002831
shader_parameter/noise_speed = 3.275
shader_parameter/static_noise_intensity = 0.2000000095
shader_parameter/aberration = 0.7050000809874999
shader_parameter/brightness = 1.4
shader_parameter/discolor = true
shader_parameter/warp_amount = 0.2000000095
shader_parameter/clip_warp = false
shader_parameter/vignette_intensity = 0.565
shader_parameter/vignette_opacity = 0.402000019095

[sub_resource type="ShaderMaterial" id="ShaderMaterial_l0kmr"]
shader = ExtResource("5_itq3j")
shader_parameter/lightning_color = Color(2.2589493, 2.0816524, 1.9930037, 0.6509804)
shader_parameter/size = 0.00800000038
shader_parameter/width = 1.0
shader_parameter/speed = 1.0
shader_parameter/cycle = 0.2
shader_parameter/ratio = 3.0
shader_parameter/time_shift = 0.5
shader_parameter/strike_count = 5
shader_parameter/strike_delay = 0.25
shader_parameter/glow_intensity = 1.0

[sub_resource type="ShaderMaterial" id="ShaderMaterial_60amn"]
shader = ExtResource("5_l0kmr")
shader_parameter/radius = 0.4
shader_parameter/softness = 0.105
shader_parameter/glow_color = Color(1, 0.9, 0.5, 1)
shader_parameter/intensity = 1.5
shader_parameter/spread = 1.0
shader_parameter/pulse_speed = 1.0

[sub_resource type="ShaderMaterial" id="ShaderMaterial_67s8b"]
shader = ExtResource("1_r8eax")
shader_parameter/circle_width = 0.05000000074506
shader_parameter/wait_time = 5.0
shader_parameter/speed = 1.5000000223518
shader_parameter/alpha_boost = 1.0
shader_parameter/scan_active = true
shader_parameter/scan_time = 0.0
shader_parameter/glow_color = Color(0.5880192, 1.5173489, 0.37140858, 1)
shader_parameter/intensity = 1.5
shader_parameter/spread = 1.0
shader_parameter/pulse_speed = 1.0

[node name="MiniMap" type="CanvasLayer"]
layer = -1
script = ExtResource("1_1la25")

[node name="SubViewportContainer" type="SubViewportContainer" parent="."]
unique_name_in_owner = true
light_mask = 0
custom_minimum_size = Vector2(350, 350)
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -175.0
offset_top = -175.0
offset_right = 175.0
offset_bottom = 175.0
grow_horizontal = 2
grow_vertical = 2
stretch = true

[node name="SubViewport" type="SubViewport" parent="SubViewportContainer"]
handle_input_locally = false
size = Vector2i(350, 350)
render_target_update_mode = 4

[node name="Background" type="TextureRect" parent="SubViewportContainer/SubViewport"]
unique_name_in_owner = true
modulate = Color(0.69687116, 0.05970768, 0.05970768, 1)
visibility_layer = 3
z_index = -1
texture_filter = 1
material = SubResource("ShaderMaterial_4ereb")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
texture = ExtResource("4_dh8qp")
expand_mode = 1

[node name="ScreenEffectRect" type="ColorRect" parent="SubViewportContainer/SubViewport"]
modulate = Color(4.9925256, 4.9925256, 4.9925256, 1)
light_mask = 0
visibility_layer = 2
material = SubResource("ShaderMaterial_l0kmr")
custom_minimum_size = Vector2(100, 100)
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Radar" type="Control" parent="SubViewportContainer/SubViewport"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="RadarTexture" type="TextureRect" parent="SubViewportContainer/SubViewport/Radar"]
visibility_layer = 3
material = SubResource("ShaderMaterial_60amn")
custom_minimum_size = Vector2(550, 550)
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
texture = ExtResource("6_l0kmr")
expand_mode = 1

[node name="ScanEffect" type="ColorRect" parent="SubViewportContainer/SubViewport/Radar"]
unique_name_in_owner = true
modulate = Color(0.8465545, 1.8247963, 0.790655, 1)
light_mask = 0
visibility_layer = 2
material = SubResource("ShaderMaterial_67s8b")
custom_minimum_size = Vector2(300, 300)
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
color = Color(0.7722081, 1.353256, 0.77744275, 1)

[node name="Menu" type="Control" parent="SubViewportContainer/SubViewport"]
z_index = 1
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="Control" type="MarginContainer" parent="SubViewportContainer/SubViewport/Menu"]
visible = false
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/margin_left = 10
theme_override_constants/margin_top = 5
theme_override_constants/margin_right = 10
theme_override_constants/margin_bottom = 5

[node name="Panel" type="Panel" parent="SubViewportContainer/SubViewport/Menu/Control"]
layout_mode = 2

[node name="LabelTitle" type="Label" parent="SubViewportContainer/SubViewport/Menu/Control/Panel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -20.0
offset_right = 20.0
offset_bottom = 23.0
grow_horizontal = 2
theme_override_font_sizes/font_size = 36
text = "CONTROL"
horizontal_alignment = 1
vertical_alignment = 1

[node name="LabelMenuC" type="Label" parent="SubViewportContainer/SubViewport/Menu/Control/Panel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -155.0
offset_top = 45.0
offset_right = 177.0
offset_bottom = 95.0
grow_horizontal = 2
theme_override_colors/font_color = Color(0.41960785, 0.9529412, 0.3882353, 1)
theme_override_font_sizes/font_size = 26
text = "Menu Controls:"

[node name="Label" type="Label" parent="SubViewportContainer/SubViewport/Menu/Control/Panel/LabelMenuC"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -166.0
offset_top = 40.0
offset_right = 166.0
offset_bottom = 115.0
grow_horizontal = 2
theme_override_constants/line_spacing = 0
theme_override_font_sizes/font_size = 24
text = "W&S: Navigate Menu
Space bar: Confirm"

[node name="LabelGameC" type="Label" parent="SubViewportContainer/SubViewport/Menu/Control/Panel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -155.0
offset_top = 160.0
offset_right = 177.0
offset_bottom = 210.0
grow_horizontal = 2
theme_override_colors/font_color = Color(0.41977924, 0.95484024, 0.38950685, 1)
theme_override_font_sizes/font_size = 26
text = "Game Controls:"

[node name="Label" type="Label" parent="SubViewportContainer/SubViewport/Menu/Control/Panel/LabelGameC"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -166.0
offset_top = 40.0
offset_right = 166.0
offset_bottom = 148.0
grow_horizontal = 2
theme_override_constants/line_spacing = 0
theme_override_font_sizes/font_size = 24
text = "Left Click: Select Target 
Right Click: Hold to move
Focus on the window first 
to take over its control"

[node name="Credits" type="MarginContainer" parent="SubViewportContainer/SubViewport/Menu"]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme_override_constants/margin_left = 10
theme_override_constants/margin_top = 5
theme_override_constants/margin_right = 10
theme_override_constants/margin_bottom = 5

[node name="Panel" type="Panel" parent="SubViewportContainer/SubViewport/Menu/Credits"]
layout_mode = 2

[node name="LabelTitle" type="Label" parent="SubViewportContainer/SubViewport/Menu/Credits/Panel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -20.0
offset_right = 20.0
offset_bottom = 23.0
grow_horizontal = 2
theme_override_font_sizes/font_size = 36
text = "Credits"
horizontal_alignment = 1
vertical_alignment = 1

[node name="LabelMenuC" type="Label" parent="SubViewportContainer/SubViewport/Menu/Credits/Panel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -155.0
offset_top = 45.0
offset_right = 177.0
offset_bottom = 95.0
grow_horizontal = 2
theme_override_colors/font_color = Color(0.41960785, 0.9529412, 0.3882353, 1)
theme_override_font_sizes/font_size = 26
text = "About The Game:"

[node name="Label" type="Label" parent="SubViewportContainer/SubViewport/Menu/Credits/Panel/LabelMenuC"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -166.0
offset_top = 40.0
offset_right = 166.0
offset_bottom = 115.0
grow_horizontal = 2
theme_override_constants/line_spacing = 0
theme_override_font_sizes/font_size = 16
text = "Themes: Nothing and What's up
\"You are stuck in here, figure out
what's up and go up to escape,
There's nothing down there......\"
Focused on Programming, Design, all the
art are from online"

[node name="LabelGameC" type="Label" parent="SubViewportContainer/SubViewport/Menu/Credits/Panel"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -155.0
offset_top = 240.0
offset_right = 177.0
offset_bottom = 290.0
grow_horizontal = 2
theme_override_colors/font_color = Color(0.41977924, 0.95484024, 0.38950685, 1)
theme_override_font_sizes/font_size = 26
text = "Assets Links:"

[node name="Label" type="Label" parent="SubViewportContainer/SubViewport/Menu/Credits/Panel/LabelGameC"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -166.0
offset_top = 40.0
offset_right = 166.0
offset_bottom = 148.0
grow_horizontal = 2
theme_override_constants/line_spacing = 0
theme_override_font_sizes/font_size = 12
text = "Left Click: Select Target 
Right Click: Hold to move
"

[node name="ScanTimer" type="Timer" parent="."]
unique_name_in_owner = true
autostart = true
